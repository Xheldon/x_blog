<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <title>
    
      博客自动化流程及体验优化——第二弹 - Xheldon Blog
        
  </title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="google-site-verification" content="EX6ES0UVArXTvp5aeeWrkXGn5M5MZ10bYqXanXDEzAs" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  
    <meta name="description" content="博客体验又更上一层楼啦！">
    
        <meta name="keywords" content="Xheldon, 生活, 美食, 旅游, 前端, 技术, 分享">
        <meta name="theme-color" content="#000000">
        <meta name="twitter:card" content="summary_large_image">
        <!-- Open Graph -->
        <meta property="og:title"
          content="博客自动化流程及体验优化——第二弹 - Xheldon Blog">
        
          <meta property="og:type" content="article">
          
            <meta property="article:published_time" content=" 2022-8-14T4:13:32"> 
              
                  
                    <meta property="article:tag" content="技术">
                    
                    <meta property="article:tag" content="优化">
                    
                    <meta property="article:tag" content="Craft">
                    
                    <meta property="article:tag" content="插件">
                    
                    <meta property="article:tag" content="CI">
                    
                    <meta property="article:tag" content="AppleScript">
                    
                    <meta property="article:tag" content="Jekyll">
                    
                      
                          
                            <meta name="og:description" content="博客体验又更上一层楼啦！">
                            
                                
                                    <meta property="twitter:image"
                                      content="https://www.xheldon.com/img/logo.png">
                                    <meta property="og:image"
                                      content="https://www.xheldon.com/img/logo.png">
                                    
                                      <meta property="og:url" content="https://www.xheldon.com/tech/optimize-of-my-blog-2.html">
                                      <meta property="og:site_name" content="Xheldon Blog">
                                      <meta name="google-adsense-account" content="ca-pub-5486286026923411">
                                      <script async
                                        src="https://fundingchoicesmessages.google.com/i/pub-5486286026923411?ers=1"
                                        nonce="hkl-3cDcQhqR8uwDMTDGjQ"></script>
                                      <script nonce="hkl-3cDcQhqR8uwDMTDGjQ">
                                        (function () {
                                          function signalGooglefcPresent() {
                                            if (!window.frames['googlefcPresent']) {
                                              if (document.body) {
                                                const iframe = document.createElement('iframe');
                                                iframe.style =
                                                  'width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;';
                                                iframe.style.display = 'none';
                                                iframe.name = 'googlefcPresent';
                                                document.body.appendChild(iframe);
                                              } else {
                                                setTimeout(signalGooglefcPresent, 0);
                                              }
                                            }
                                          }
                                          signalGooglefcPresent();
                                        })();
                                      </script>
                                      <script async
                                        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5486286026923411"
                                        crossorigin="anonymous"></script>

                                      <!-- Web App Manifest -->
                                      <link rel="manifest" href="/js/manifest.json">
                                      <link rel="shortcut icon" href="/img/favicon.ico">
                                      <link rel="canonical"
                                        href="https://www.xheldon.com/tech/optimize-of-my-blog-2.html">

                                      <!-- Bootstrap Core CSS -->
                                      <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">

                                      <!-- Custom CSS -->
                                      <link rel="stylesheet" href="/css/xblog.min.css" type="text/css">

                                      <!-- Pygments Highlight CSS -->
                                      <link rel="stylesheet" href="/css/highlight.css" type="text/css">

                                      <!-- Custom Fonts -->
                                      <link href="/css/font-awesome.min.css" rel="stylesheet" type="text/css">

                                      <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                                      <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                                      <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
<meta name="generator" content="Hexo 7.3.0"></head>

  <!-- hack iOS CSS :active style -->

  <body ontouchstart="">
    <!-- Navigation -->
    
  <nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
    
          <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
              <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="/">
                Xheldon Blog
              </a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="xblog_navbar">
              <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                  <li>
                    <a href="/">Home</a>
                  </li>
                  <li>
                    <a href="/about/">About</a>
                  </li>
                  <li>
                    <a href="/donate/">Donate</a>
                  </li>
                  <li>
                    <a href="/archive/">Archive</a>
                  </li>
                  <li>
                    <a href="/feed.xml">Rss</a>
                  </li>
                  <li class="search-icon">
                    <a href="javascript:void(0)">
                      <i class="fa fa-search"></i>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <!-- /.navbar-collapse -->
          </div>
          <!-- /.container -->
      </nav>
      <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        document.addEventListener('DOMContentLoaded', function () {

          var $body = document.body;
          var $toggle = document.querySelector('.navbar-toggle');
          var $navbar = document.querySelector('#xblog_navbar');
          var $collapse = document.querySelector('.navbar-collapse');
          console.log('shit22');
          var __XNav__ = {
            close: function () {
              $navbar.className = ' ';
              // wait until animation end.
              setTimeout(function () {
                // prevent frequently toggle
                if ($navbar.className.indexOf('in') < 0) {
                  $collapse.style.height = '0px';
                }
              }, 400);
            },
            open: function () {
              $collapse.style.height = 'auto';
              $navbar.className += ' in';
            },
          };
          // Bind Event
          $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
              __XNav__.close();
            } else {
              __XNav__.open();
            }
          });
          /**
           * Since Fastclick is used to delegate 'touchstart' globally
           * to hack 300ms delay in iOS by performing a fake 'click',
           * Using 'e.stopPropagation' to stop 'touchstart' event from
           * $toggle/$collapse will break global delegation.
           *
           * Instead, we use a 'e.target' filter to prevent handler
           * added to document close XheldonNav.
           *
           * Also, we use 'click' instead of 'touchstart' as compromise
           */
          document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __XNav__.close();
          });
        });
      </script> <!-- Search -->
<div class="search-page">
    <div class="search-icon-close-container">
      <span class="search-icon-close">
        <i class="fa fa-chevron-down"></i>
      </span>
    </div>
    <div class="search-main container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          <form></form>
          <input type="text" id="search-input" placeholder="$ grep...">
          </form>
          <div id="search-results" class="mini-post-list"></div>
        </div>
      </div>
    </div>
  </div>

    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="https://www.xheldon.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/" width="0" height="0"> -->

<style type="text/css">
  header.intro-header {
    position: relative;
    background-image: url("https://static.xheldon.cn//img/index-bg.png");

    
  }

  
</style>

  <header class="intro-header style-text">
    
          <div class="headerMask"></div>
          
              <div class="container">
                <div class="row">
                  <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                      <div class="tags">
                        
                          <a class="tag" href="/archive/?tag=%E6%8A%80%E6%9C%AF"
                            title="技术">
                            技术
                          </a>
                          
                          <a class="tag" href="/archive/?tag=%E4%BC%98%E5%8C%96"
                            title="优化">
                            优化
                          </a>
                          
                          <a class="tag" href="/archive/?tag=Craft"
                            title="Craft">
                            Craft
                          </a>
                          
                          <a class="tag" href="/archive/?tag=%E6%8F%92%E4%BB%B6"
                            title="插件">
                            插件
                          </a>
                          
                          <a class="tag" href="/archive/?tag=CI"
                            title="CI">
                            CI
                          </a>
                          
                          <a class="tag" href="/archive/?tag=AppleScript"
                            title="AppleScript">
                            AppleScript
                          </a>
                          
                          <a class="tag" href="/archive/?tag=Jekyll"
                            title="Jekyll">
                            Jekyll
                          </a>
                          
                      </div>
                      <h1>
                        博客自动化流程及体验优化——第二弹
                      </h1>
                      <h2 class="subheading">
                        
                      </h2>
                      <span class="meta">✍🏼 写于 2022年08月14日</span>&nbsp;&nbsp;&nbsp;
                      
                        <span class="meta">💡 更新于 2022年08月25日</span>
                        
                    </div>
                  </div>
                </div>
              </div>
      </header>

  <!-- Post Content -->
  <article>
    <div class="container">
      <div class="row">

        <!-- Post Container -->
        <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">
          
            
              <div class="time-tips">❗️&nbsp;注意：离本文创建时间已经过去了 <code id="from_time"></code> 天，请注意时效性</div>
              <script>
                var timeDom = document.getElementById('from_time');
                var pageTime = Date.parse('Sun Aug 14 2022 16:13:32 GMT+0000');
                var currentTime = Date.now();
                var fromNow = ((currentTime - (pageTime * 1000)) / (24 * 3600 * 1000)).toFixed(0);
                if (Number(fromNow) <= 0) {
                  fromNow = 1; // Note: 至少显示一天
                }
                timeDom.innerText = fromNow
              </script>
              
                
                    
                      
                        <div class="callout-tips">🖥 &nbsp;说明：博客体验又更上一层楼啦！
                        </div>
                        
                          
                            <div class="craft-tips">📚 &nbsp;本文同步发布在 Craft：<a href="https://www.craft.do/s/BJ8gIm5fmtdOCB" target="_blank">
                                https://www.craft.do/s/BJ8gIm5fmtdOCB
                              </a></div>
                            
                              
                                  <h2 id="前言">前言</h2>
<p>之前搞了个 <a href="/tech/my-blog-ci.html">博客自动化流程</a>，及后来的 <a href="/tech/my-blog-ci-in-2022.html">2022 博客自动化流程</a> 但是总的来说，还有以下痛点：</p>
<ol>
<li>
<p>从 Github CI 上传从 Craft 拉的图片到腾讯云经常会遇到网络错误，流程不可控。</p>
</li>
<li>
<p>博客中图片传到腾讯云的时候，都被强制转为 <code>png</code> ，但是其实应该支持更多格式如 <code>gif</code> 。</p>
</li>
<li>
<p>Craft 转 Markdown 的结果，有很多与标准 Markdown 不同的地方，如：</p>
<ol>
<li>
<p>不支持嵌套列表。</p>
</li>
<li>
<p>引用块内嵌套列表的时候，渲染结果列表居然在外层。</p>
</li>
<li>
<p>Craft 的 「焦点」（block）和「块」（focus）只有后者被识别成 blockquote （引用块），预期应该是二者都是。</p>
</li>
<li>
<p>Craft 中的 bookmark 信息量很多，如页面描述、页面 title 等，但是转成 Markdown 的之后，仅剩下一个段落中包裹着链接，相当于信息丢失了。</p>
</li>
<li>
<p>Craft 中图片本身就不支持图片说明。</p>
</li>
<li>
<p>Craft 生成的代码块，并不会自动在反引号之后添加语言，导致一些语言被识别为了 <code>plaintext</code> 没有高亮。</p>
</li>
</ol>
</li>
</ol>
<p>于是本次优化针对这些痛点，又又又又进行了改造。</p>
<h2 id="优化一：使用自己的-craftblocktomarkdown-函数">优化一：使用自己的 CraftBlockToMarkdown 函数</h2>
<p>因为给 Craft 反馈了他们的 <code>craft.markdown.craftBlockToMarkdown</code> 无法正确转换的问题：</p>
<p><a class='link-bookmark' href='https://forum.developer.craft.do/t/wrong-render-of-markdown-with-decoration-focus-and-image-question/235' target='_blank'><span data-bookmark-img='https://global.discourse-cdn.com/standard11/uploads/craft/original/1X/5add1bbc4f01c418389d213f2ed49867e2fc8e79.png' data-bookmark-title='W'><img src='https://global.discourse-cdn.com/standard11/uploads/craft/original/1X/5add1bbc4f01c418389d213f2ed49867e2fc8e79.png'/></span><span><span> Wrong render of markdown with Decoration focus and image question</span><span> Decoration block ‘focus’ should be render as ‘blockquote’ but now the markdow API craftBlockToMarkdown(flavor is ‘common’) is ignore this block type and render as plain text. The URI of Image return by markdow API craftBlockToMarkdown is avaliable in every place, which may cause some problem, I hope there will be a site white list setting, only allow those site in the list to use the image in my document. this strategy can make the AWS cost of data traffic down, too.</span><span> https://forum.developer.craft.do/t/wrong-render-of-markdown-with-decoration-focus-and-image-question/235</span></span></a></p>
<p>但是官方似乎丝毫没有要解决的意思，于是自己写了一个简单的函数用来手动转换：</p>
<p><a class='link-bookmark' href='https://gist.github.com/Xheldon/036d9b187bd83303205001e8af97eda7' target='_blank'><span data-bookmark-img='https://github.githubassets.com/images/modules/gists/gist-og-image.png' data-bookmark-title='C'><img src='https://github.githubassets.com/images/modules/gists/gist-og-image.png'/></span><span><span> craftBlockToMarkdown</span><span> GitHub Gist: instantly share code, notes, and snippets.</span><span> https://gist.github.com/Xheldon/036d9b187bd83303205001e8af97eda7</span></span></a></p>
<p>需要注意的是，该函数因为是自己用来适配 Jekyll 的来进行下一步处理的（见下面的优化三），因此特殊处理了 <code>imageBlock</code> 和 <code>urlBlock</code> 类型的 Block：</p>
<p caption='Image'><img src='https://static.xheldon.cn/img/in-post/2022/optimize-of-my-blog-2/FE4436B8-B16D-4CA7-9041-E2F5F831CC80_2.png' alt='Image' title='Image'></p>
<p>此函数已经被我放到官方插件开发者论坛了，欢迎交流：</p>
<p><a class='link-bookmark' href='https://forum.developer.craft.do/t/a-better-implementation-of-craft-blocks-to-markdown-transformation-methods/554' target='_blank'><span data-bookmark-img='https://global.discourse-cdn.com/standard11/uploads/craft/original/1X/5add1bbc4f01c418389d213f2ed49867e2fc8e79.png' data-bookmark-title='A'><img src='https://global.discourse-cdn.com/standard11/uploads/craft/original/1X/5add1bbc4f01c418389d213f2ed49867e2fc8e79.png'/></span><span><span> A better implementation of craft blocks to Markdown transformation methods</span><span> Craft’s markdown api has the following problems: 1. Nested lists are not supported. 2. The order of Nested blockquote and is incorrectly. 3. only the latter will be recognized as a reference block. 4. urlBlock (may called ‘bookmark’?) will be recognized as a link（in this function, you can custom render tag of jekyll, you can modify this as you wish) Note: 1. not support toggle/formula, because markdown not support those too, but you can make it. 2. I use this function for may jekyll blog ...</span><span> https://forum.developer.craft.do/t/a-better-implementation-of-craft-blocks-to-markdown-transformation-methods/554</span></span></a></p>
<h2 id="优化二：将-github-ci-流程挪到本地">优化二：将 Github CI 流程挪到本地</h2>
<p>之前的流程，点击插件的发布按钮（当然，需要先填写 GitHub Token、填写 COS 等相关信息才行），然后等着就可以了。</p>
<p>本次优化，为了保持与之前流程的一致，于是又写了个 Craft 插件，点击后会获取文档内容，简单处理后（如获取 headerImg 的图片版权信息到 meta 中），会调用特定链接，链接参数带上文档信息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">craft.<span class="hljs-property">editorApi</span>.<span class="hljs-title function_">openURL</span>(<br>  <span class="hljs-string">`xhelper://<span class="hljs-subst">$&#123;btoa(<span class="hljs-built_in">unescape</span>(<span class="hljs-built_in">encodeURIComponent</span>(content)))&#125;</span>`</span><br>);<br></code></pre></td></tr></table></figure>
<p>而这个特定链接的作用，就是调用 Apple Script 写的 Application，置于如何写一个 Application 应用和如何响应链接调用，可以看我写的 <a href="/tech/applescript-simple-use.html">这篇文档</a>，里面会调用 node，执行的其实也是之前放到 Github CI 执行的代码，这里放一个简单的截图：</p>
<p caption='Xhelper截图👆🏻'><img src='https://static.xheldon.cn/img/in-post/2022/optimize-of-my-blog-2/BC93AD26-26C5-4AD1-A8AC-2BB3B2AD2945_2.png' alt='Xhelper截图👆🏻' title='Xhelper截图👆🏻'></p>
<p>效果：</p>
<p caption='Image'><img src='https://static.xheldon.cn/img/in-post/2022/optimize-of-my-blog-2/5E5FDC00-D081-4B50-91FE-61946A453356_2.png' alt='Image' title='Image'></p>
<p>之前的流程因为我贪图简单，加上 Craft 上传的图片不一定都有后缀（如通过拖拽、图片上传等方式上传的图片，则有后缀，若通过复制粘贴来的或者 Web 上传的图片，则无后缀），于是我将所有图片都转成了 <code>png</code> 格式，本次我移除了这个逻辑，先判断如果自身带后缀则使用其后缀；如果没有后缀，则再将其强制转为 <code>png</code> ，推荐使用 <code>Sharp</code> 这个库，非~常~好~用~：</p>
<p><a class='link-bookmark' href='https://sharp.pixelplumbing.com/' target='_blank'><span data-bookmark-img='https://cdn.jsdelivr.net/gh/lovell/sharp@main/docs/image/sharp-logo.png' data-bookmark-title='S'><img src='https://cdn.jsdelivr.net/gh/lovell/sharp@main/docs/image/sharp-logo.png'/></span><span><span> sharp - High performance Node.js image processing</span><span> "Resize large images in common formats to smaller, web-friendly JPEG, PNG, WebP, GIF and AVIF images of varying dimensions"</span><span> https://sharp.pixelplumbing.com/</span></span></a></p>
<p>所以…上 Gif！</p>
<p caption='支持gif啦'><img src='https://static.xheldon.cn/img/in-post/2022/optimize-of-my-blog-2/59E358FD-2A7A-4125-8223-1A51FFCCC8A3_2.gif' alt='支持gif啦' title='支持gif啦'></p>
<blockquote>
<p>注：之前贪图方便（不用鉴权、不用固定 ip 的服务器），用了 <a href="https://cloud.weixin.qq.com/cloudrun">微信云托管</a>，还顺便实现了将摘要往微信公众号发送的逻辑。但是坑爹的是，这个服务器仅仅是我为了方便发布公众号而弄的，但是按我性子一般三个月就用一次，每次用的时候还是冷启动（它服务器默认 30 分钟无请求进来自动关闭实例，因为他们是按实例运行时间计费的），会经常性的失败，有这排查的功夫我都自己都复制粘贴文档到微信公众号的编辑器了。所以，我放弃了微信公众号，手动粘贴…也挺好！</p>
</blockquote>
<h2 id="优化三：实现-craft-中的-bookmark-和图片-caption">优化三：实现 Craft 中的 Bookmark 和图片 Caption</h2>
<p>能在基于 Jekyll 的博客系统来实现这个效果是因为我并没有直接用 Github 的 Jekyll 服务，而是自己用 Jekyll build 成 HTML 后，再 push 到仓库中实现的，原因及过程见 <a href="https://www.xheldon.com/tech/my-blog-ci.html#%E9%85%8D%E7%BD%AE-github-actions-build-%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6">这里</a>。</p>
<p>实现 Bookmark 和图片 Caption 是利用了上一步生成的 Markdown 中含有的特殊 Jekyll 标签，配合自定义的 Jekyll 插件实现的，渲染 Bookmark 就用 <code>render_bookmark</code> ，渲染图片 caption 用 <code>render_caption</code> 实现（用了刚学了两小时的 ruby 脚本语言）：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">module</span> <span class="hljs-title class_">Jekyll</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">RenderBookMarkBlock</span> &lt; <span class="hljs-title class_ inherited__">Liquid::Block</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params">tag_name, attr, tokens</span>)<br>            <span class="hljs-variable language_">super</span><br>            attrs = attr.scan(<span class="hljs-regexp">/url\=\&quot;(.*)\&quot;\stitle\=\&quot;(.*)\&quot;\simg\=\&quot;(.*)\&quot;/</span>)<br>            <span class="hljs-variable">@url</span> = attrs[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>            <span class="hljs-variable">@title</span> = attrs[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]<br>            <span class="hljs-variable">@img</span> = attrs[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>]<br>            <span class="hljs-variable">@error</span> = <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">context</span>)<br>            <span class="hljs-variable">@desc</span> = <span class="hljs-variable language_">super</span><br>            <span class="hljs-string">&quot;&lt;p&gt;&lt;a class=&#x27;link-bookmark&#x27; href=&#x27;<span class="hljs-subst">#&#123;<span class="hljs-variable">@url</span>&#125;</span>&#x27;&gt;&lt;span&gt;&lt;img src=&#x27;<span class="hljs-subst">#&#123;<span class="hljs-variable">@img</span>&#125;</span>&#x27;/&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;<span class="hljs-subst">#&#123;<span class="hljs-variable">@title</span>&#125;</span>&lt;/span&gt;&lt;span&gt;<span class="hljs-subst">#&#123;<span class="hljs-variable">@desc</span>&#125;</span>&lt;/span&gt;&lt;span&gt;<span class="hljs-subst">#&#123;<span class="hljs-variable">@url</span>&#125;</span>&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&quot;</span><br>        <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">module</span> <span class="hljs-title class_">Jekyll</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">RenderImageCaptionBlock</span> &lt; <span class="hljs-title class_ inherited__">Liquid::Block</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params">tag_name, attr, tokens</span>)<br>            <span class="hljs-variable language_">super</span><br>            attrs = attr.scan(<span class="hljs-regexp">/caption\=\&quot;(.*)\&quot;\simg\=\&quot;(.*)\&quot;/</span>)<br>            <span class="hljs-variable">@caption</span> = attrs[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>            <span class="hljs-variable">@img</span> = attrs[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">context</span>)<br>            text = <span class="hljs-variable language_">super</span><br>            <span class="hljs-string">&quot;&lt;p caption=&#x27;<span class="hljs-subst">#&#123;<span class="hljs-variable">@caption</span>&#125;</span>&#x27;&gt;&lt;img src=&#x27;<span class="hljs-subst">#&#123;<span class="hljs-variable">@img</span>&#125;</span>&#x27; alt=&#x27;<span class="hljs-subst">#&#123;<span class="hljs-variable">@caption</span>&#125;</span>&#x27; title=&#x27;<span class="hljs-subst">#&#123;<span class="hljs-variable">@caption</span>&#125;</span>&#x27; /&gt;&lt;/p&gt;&quot;</span><br>        <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-title class_">Liquid</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:Template</span>.register_tag(<span class="hljs-string">&#x27;render_caption&#x27;</span>, <span class="hljs-title class_">Jekyll</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:RenderImageCaptionBlock</span>)<br><span class="hljs-title class_">Liquid</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:Template</span>.register_tag(<span class="hljs-string">&#x27;render_bookmark&#x27;</span>, <span class="hljs-title class_">Jekyll</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:RenderBookMarkBlock</span>)<br></code></pre></td></tr></table></figure>
<p>Jekyll 使用插件非常简单，在根目录新建一个 <code>_plugins</code> 目录，将用<code>ruby</code> 写的 Jekyll 插件放进去即可在 Jekyll Build 的时候加载该插件。</p>
<h2 id="其他细节">其他细节</h2>
<p>之前的内容算是标准 Markdown 生成的 HTML，因此一些 RSS 阅读器抓取内容后格式良好，但是本次优化加了个 Bookmark 之后，RSS 格式就乱了（截图来自 Reeder 5）：</p>
<p caption='Reeder5中Bookmark格式错乱'><img src='https://static.xheldon.cn/img/in-post/2022/optimize-of-my-blog-2/B1E25DC1-17C1-45D8-8721-8160FDCA1676_2.jpeg' alt='Reeder5中Bookmark格式错乱' title='Reeder5中Bookmark格式错乱'></p>
<p>于是又写了个 ruby 插件，过滤该标签，将其转成普通的 HTML 链接：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">module</span> <span class="hljs-title class_">Jekyll</span><br>    <span class="hljs-keyword">module</span> <span class="hljs-title class_">BookmarkFilter</span><br>      <span class="hljs-keyword">def</span> <span class="hljs-title function_">bookmark_filter</span>(<span class="hljs-params">input</span>)<br>        input.gsub(<span class="hljs-regexp">/^\&lt;p\&gt;\&lt;a\s+class=\&quot;link-bookmark\&quot;\shref=(.*)\starget=\&quot;_blank\&quot;\&gt;\&lt;span\&gt;(.*)\&lt;\/span\&gt;\&lt;span\&gt;\&lt;span\&gt;(.*)\&lt;\/span\&gt;\&lt;span\&gt;\n(.*)\n\&lt;\/span\&gt;\&lt;span\&gt;(.*)\&lt;\/span\&gt;\&lt;\/span\&gt;\&lt;\/a\&gt;\&lt;\/p\&gt;$/</span>, <span class="hljs-string">&#x27;&lt;p&gt;&lt;a href=\1 target=&quot;_blank&quot;&gt;\4&lt;/a&gt;&lt;/p&gt;&#x27;</span>);<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-title class_">Liquid</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:Template</span>.register_filter(<span class="hljs-title class_">Jekyll</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:BookmarkFilter</span>)<br></code></pre></td></tr></table></figure>
<p>然后再在 feed.xml 中使用即可： <code>post.content | bookmark_filter</code> 。</p>
<p>欢迎交流！</p>

                                    <div class="text-danger">- EOF -</div>
                                    <div style="font-size: 12px; color: #ccc!important;">本文最先发布在: <a
                                        style="color: #ccc;"
                                        href="https://www.xheldon.com/tech/optimize-of-my-blog-2.html"
                                        title="博客自动化流程及体验优化——第二弹">
                                        博客自动化流程及体验优化——第二弹 - Xheldon Blog
                                      </a></div>
                                    <hr style="visibility: hidden;">

                                    <ul class="pager">
                                      
                                        <li class="previous">
                                          <a href="/tech/javascript-debugger-reference-series01.html" data-toggle="tooltip"
                                            data-placement="top" title="「译」官方指南系列：JavaScript 调试指南（一）">
                                            上一篇<br>
                                            <span>{{page.prev.title}}</span>
                                          </a>
                                        </li>
                                        
                                          
                                            <li class="next">
                                              <a href="/tech/the-use-of-chrome-devtools.html" data-toggle="tooltip"
                                                data-placement="top" title="Chrome 常用调试方法及其他">
                                                下一篇<br>
                                                <span>{{page.next.title}}</span>
                                              </a>
                                            </li>
                                            
                                    </ul>
                                    <hr style="visibility: hidden;">
                                    <div class="giscus"></div>
                                    <hr>
        </div>
        <!-- Side Catalog Container -->
        
          <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
            <div class="side-catalog">
              <hr class="hidden-sm hidden-xs">
              <h5>
                <a class="catalog-toggle" href="#">目录</a>
              </h5>
              <ul class="catalog-body"></ul>
            </div>
          </div>
          

            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">
              
<section style="margin-bottom: 20px;">
    <h5>博主说：</h5>
    <div>
        <img style="float: right; max-width: 120px; max-height: 120px; margin-right: 5px; margin-top: -45px;" src="/img/gwechat.png" />
        我常常希望在面对人生中一些关键抉择的时候，有人可以告诉我最佳的做法，让我不至于白白浪费宝贵的时间。推己及人，我因此经常写博客，以期在浩渺无垠的互联网中的这个小小角落里记录下对于我来说只有一次的人生经历，希望能够帮到那些希望得到帮助的人。
    </div>
    <hr>
    <h5><a href="/archive/">热门标签</a></h5>
    <div class="tags">
        

        
            <a data-sort="0028" 
                href="/archive/?tag=%E6%8A%80%E6%9C%AF"
                title="技术"
                rel="44">技术</a>
        
            <a data-sort="0047" 
                href="/archive/?tag=%E7%94%9F%E6%B4%BB"
                title="生活"
                rel="25">生活</a>
        
            <a data-sort="0062" 
                href="/archive/?tag=%E6%8A%98%E8%85%BE"
                title="折腾"
                rel="10">折腾</a>
        
            <a data-sort="0066" 
                href="/archive/?tag=%E7%BF%BB%E8%AF%91"
                title="翻译"
                rel="6">翻译</a>
        
            <a data-sort="0067" 
                href="/archive/?tag=%E6%8A%80%E5%B7%A7"
                title="技巧"
                rel="5">技巧</a>
        
            <a data-sort="0067" 
                href="/archive/?tag=%E6%95%99%E7%A8%8B"
                title="教程"
                rel="5">教程</a>
        
            <a data-sort="0067" 
                href="/archive/?tag=%E7%BE%8E%E9%A3%9F"
                title="美食"
                rel="5">美食</a>
        
            <a data-sort="0067" 
                href="/archive/?tag=ProseMirror"
                title="ProseMirror"
                rel="5">ProseMirror</a>
        
            <a data-sort="0068" 
                href="/archive/?tag=%E5%B7%A5%E4%BD%9C%E6%B5%81"
                title="工作流"
                rel="4">工作流</a>
        
            <a data-sort="0068" 
                href="/archive/?tag=%E6%8F%92%E4%BB%B6"
                title="插件"
                rel="4">插件</a>
        
            <a data-sort="0068" 
                href="/archive/?tag=%E7%BD%91%E7%BB%9C"
                title="网络"
                rel="4">网络</a>
        
            <a data-sort="0068" 
                href="/archive/?tag=Craft"
                title="Craft"
                rel="4">Craft</a>
        
            <a data-sort="0068" 
                href="/archive/?tag=Vue"
                title="Vue"
                rel="4">Vue</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=%E5%88%9D%E4%BD%93%E9%AA%8C"
                title="初体验"
                rel="3">初体验</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=%E6%9C%8D%E5%8A%A1%E5%99%A8"
                title="服务器"
                rel="3">服务器</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=%E7%BB%8F%E9%AA%8C"
                title="经验"
                rel="3">经验</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=%E8%8B%B9%E6%9E%9C"
                title="苹果"
                rel="3">苹果</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=%E8%B7%AF%E7%94%B1%E5%99%A8"
                title="路由器"
                rel="3">路由器</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=%E8%BD%AF%E8%B7%AF%E7%94%B1"
                title="软路由"
                rel="3">软路由</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=%E9%9A%8F%E7%AC%94"
                title="随笔"
                rel="3">随笔</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=%E9%9B%86%E6%88%90"
                title="集成"
                rel="3">集成</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=Apple"
                title="Apple"
                rel="3">Apple</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=Git"
                title="Git"
                rel="3">Git</a>
        
            <a data-sort="0069" 
                href="/archive/?tag=JavaScript"
                title="JavaScript"
                rel="3">JavaScript</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E4%B8%BB%E9%A3%9F"
                title="主食"
                rel="2">主食</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E4%BC%98%E5%8C%96"
                title="优化"
                rel="2">优化</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C"
                title="使用体验"
                rel="2">使用体验</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E5%8D%83%E5%85%86"
                title="千兆"
                rel="2">千兆</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E5%A4%A7%E4%BA%8B"
                title="大事"
                rel="2">大事</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E6%97%81%E8%B7%AF%E7%94%B1"
                title="旁路由"
                rel="2">旁路由</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E6%B3%A1%E8%84%9A%E6%97%B6%E9%97%B4"
                title="泡脚时间"
                rel="2">泡脚时间</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E6%B5%8B%E8%AF%95"
                title="测试"
                rel="2">测试</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E7%89%B9%E6%96%AF%E6%8B%89"
                title="特斯拉"
                rel="2">特斯拉</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E7%BC%96%E8%BE%91%E5%99%A8"
                title="编辑器"
                rel="2">编辑器</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E8%A7%86%E9%A2%91"
                title="视频"
                rel="2">视频</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E8%B0%83%E8%AF%95"
                title="调试"
                rel="2">调试</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E8%BD%A6"
                title="车"
                rel="2">车</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=%E8%BF%81%E7%A7%BB"
                title="迁移"
                rel="2">迁移</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=AppleScript"
                title="AppleScript"
                rel="2">AppleScript</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=CI"
                title="CI"
                rel="2">CI</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=GitHub"
                title="GitHub"
                rel="2">GitHub</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=Jekyll"
                title="Jekyll"
                rel="2">Jekyll</a>
        
            <a data-sort="0070" 
                href="/archive/?tag=Notion"
                title="Notion"
                rel="2">Notion</a>
        
    </div>
    <hr>
    <h5>专栏</h5>
    <div class="tags">
        <a href="/projects">开源项目</a>
        <a href="/book-list">技术书单</a>
        <a href="/subscribe">订阅&付费软件</a>
        <a href="/my-food">美食推荐</a>
    </div>
</section>

                
<hr>
<h5>朋友们</h5>
<ul class="list-inline">
  
  <li><a href="https://prosemirror.xheldon.com" target="_blank">ProseMirror 中文</a></li>
  
  <li><a href="https://rust.xheldon.com" target="_blank">Rust 中文</a></li>
  
  <li><a href="https://slate.xheldon.com" target="_blank">Slate 中文</a></li>
  
  <li><a href="https://notion-flow.xheldon.com" target="_blank">Notion Flow</a></li>
  
  <li><a href="https://xpic.xheldon.com" target="_blank">xPic</a></li>
  
  
    <li><a href="https://www.xheldon.cn" target="_blank">国内版</a></li>
  
</ul>

            </div>
      </div>
    </div>
  </article>

  

        

            <script src="https://giscus.app/client.js"
        data-repo="Xheldon/x_blog"
        data-repo-id="MDEwOlJlcG9zaXRvcnk1MDgyODA3Ng=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAweTLM4B_uhM"
        data-mapping="specific"
        data-term="博客自动化流程及体验优化——第二弹"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

              
                <!-- async load function -->
                <script>
                  function async(u, c) {
                    var d = document,
                      t = 'script',
                      o = d.createElement(t),
                      s = d.getElementsByTagName(t)[0];
                    o.src = u;
                    if (c) {
                      o.addEventListener('load', function (e) {
                        c(null, e);
                      }, false);
                    }
                    s.parentNode.insertBefore(o, s);
                  }
                </script>
                <!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
                <script>
                  async("/js/anchor.min.js", function () {
                    anchors.options = {
                      visible: 'always',
                      placement: 'right',
                      //   icon: '#'
                    };
                    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
                  })
                </script>
                <style>
                  /* place left on bigger screen */
                  @media all and (min-width: 800px) {
                    .anchorjs-link {
                      position: absolute;
                      left: -0.75em;
                      font-size: 1.1em;
                      margin-top: -0.1em;
                    }
                  }
                </style>
                

    <!-- Footer -->
    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <!-- @param {Boolean} center -->

<ul class="list-inline text-center">
   
    <li>
      <a target="_blank" href="https://twitter.com/_xheldon">
        <span class="fa-stack fa-lg">
          <i class="fa fa-circle fa-stack-2x"></i>
          <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
      </a>
    </li>
      
    <li>
      <a target="_blank" href="http://weibo.com/xheldon">
        <span class="fa-stack fa-lg">
          <i class="fa fa-circle fa-stack-2x"></i>
          <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
        </span>
      </a>
    </li>
       
    <li>
      <a
        target="_blank"
        href="https://www.youtube.com/@xheldon"
      >
        <span class="fa-stack fa-lg">
          <i class="fa fa-circle fa-stack-2x"></i>
          <i class="fa fa-youtube fa-stack-1x fa-inverse"></i>
        </span>
      </a>
    </li>
     
    <li>
      <a
        target="_blank"
        href="https://space.bilibili.com/13835416"
      >
        <span class="fa-stack fa-lg">
          <i class="fa fa-circle fa-stack-2x"></i>
          <i class="fa fa-youtube-play fa-stack-1x fa-inverse"></i>
        </span>
      </a>
    </li>
      
    <li>
      <a target="_blank" href="https://t.me/xheldon_tech">
        <span class="fa-stack fa-lg">
          <i class="fa fa-circle fa-stack-2x"></i>
          <i class="fa fa-plane fa-stack-1x fa-inverse"></i>
        </span>
      </a>
    </li>
    
  </ul>
</ul>

          <p class="copyright text-muted">
            Copyright &copy;
            <a href="https://github.com/Xheldon" target="_blank">Xheldon</a>
            2024
              <br>
              Don't Panic | Theme fork from
              <a href="https://github.com/Huxpro/huxpro.github.io" target="_blank">Hux</a>
              <br>
              
          </p>
      </div>
    </div>
  </div>
</footer>
<script>
  if (window.matchMedia('(prefers-color-scheme)').media === 'not all') {
    console.log('浏览器不支持主题色');
  } else {
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.remove('light');
      document.documentElement.classList.add('dark');
      // Note: 推特列表添加暗黑主题
      let ttl = document.querySelector('.twitter-timeline');
      if (ttl) {
        ttl.setAttribute('data-theme', 'dark');
      }
    }
    if (window.matchMedia('(prefers-color-scheme: light)').matches) {
      document.documentElement.classList.remove('dark');
      document.documentElement.classList.add('light');
      let ttl = document.querySelector('.twitter-timeline');
      if (ttl) {
        ttl.removeAttribute('data-theme');
      }
    }
    // document.getElementById('dark-mode').addEventListener('click', function() {
    //     document.documentElement.classList.remove('light');
    //     document.documentElement.classList.add('dark');
    // });
    // document.getElementById('light-mode').addEventListener('click', function() {
    //     document.documentElement.classList.add('light');
    //     document.documentElement.classList.remove('dark');
    // });
    // Note: 自动切换
    window
      .matchMedia('(prefers-color-scheme: dark)')
      .addListener(function (mediaQueryList) {
        if (mediaQueryList.matches) {
          document.documentElement.classList.add('dark');
          document.documentElement.classList.remove('light');
        }
      });
    window
      .matchMedia('(prefers-color-scheme: light)')
      .addListener(function (mediaQueryList) {
        if (mediaQueryList.matches) {
          document.documentElement.classList.add('light');
          document.documentElement.classList.remove('dark');
        }
      });
  }
</script>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/xheldon-life-blog.min.js?202405251426"></script>


<!-- Simple Jekyll Search 复制逻辑 -->
<script defer src='/js/simple-jekyll-search.min.js'></script>

<!-- Vercel web analysis -->

  <script defer src="/_vercel/insights/script.js"></script>
  

    <!-- Service Worker 不要了，不然总弹那个资源更新的按钮，很烦 -->

    <!-- async load function -->
    <script>
      function async(u, c) {
        var d = document,
          t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) {
          o.addEventListener(
            'load',
            function (e) {
              c(null, e);
            },
            false
          );
        }
        s.parentNode.insertBefore(o, s);
      }
    </script>

    <!-- TODO: 原博客看着有个叫 plchart 的东西，不知道是啥，也没有用，先不管了 -->

    <!-- jquery.tagcloud.js -->
    

        <!--fastClick.js -->
        <script>
          async('/js/fastclick.min.js', function () {
            var $nav = document.querySelector('nav');
            if ($nav) FastClick.attach($nav);
          });
        </script>

        <!-- Google Analytics -->
        
          <script async src="https://www.googletagmanager.com/gtag/js?id=UA-79359216-1"></script>
          <script>
            window.dataLayer = window.dataLayer || [];

            function gtag() {
              dataLayer.push(arguments);
            }
            gtag('js', new Date());

            gtag('config', '{{config.ga_track_id}}');
          </script>
          

            <!-- Side Catalog -->
            
              <script type="text/javascript">
                function generateCatalog(selector) {
                  // TODO: 多语种没有迁移过来
                  // init
                  var P = $('div.post-container'),
                    a,
                    n,
                    t,
                    l,
                    i,
                    c;
                  a = P.find('h1,h2,h3,h4,h5,h6');

                  // clean
                  $(selector).html('');

                  // appending
                  a.each(function () {
                    n = $(this).prop('tagName').toLowerCase();
                    i = '#' + $(this).prop('id');
                    t = $(this).text();
                    c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
                    l = $('<li class="' + n + '_nav"></li>').append(c);
                    $(selector).append(l);
                  });
                  return true;
                }

                generateCatalog('.catalog-body');

                // toggle side catalog
                $('.catalog-toggle').click(function (e) {
                  e.preventDefault();
                  $('.side-catalog').toggleClass('fold');
                });

                /*
                 * Doc: https://github.com/davist11/jQuery-One-Page-Nav
                 * Fork by Hux to support padding
                 */
                async('/js/jquery.nav.js',
                  function () {
                    $('.catalog-body').onePageNav({
                      currentClass: 'active',
                      changeHash: !1,
                      easing: 'swing',
                      filter: '',
                      scrollSpeed: 700,
                      scrollOffset: 0,
                      scrollThreshold: 0.2,
                      begin: null,
                      end: null,
                      scrollChange: null,
                      padding: 80,
                    });
                  }
                );
              </script>
              

                <script>
                  // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
                  function htmlDecode(input) {
                    var e = document.createElement('textarea');
                    e.innerHTML = input;
                    // handle case of empty input
                    return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
                  }


                  $(document).ready(function () {
                    SimpleJekyllSearch({
                      searchInput: document.getElementById('search-input'),
                      resultsContainer: document.getElementById('search-results'),
                      json: '/search.json',
                      searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
                      noResultsText: 'No results',
                      limit: 50,
                      fuzzy: false,
                      // a hack to get escaped subtitle unescaped. for some reason, 
                      // post.subtitle w/o escape filter nuke entire search.
                      templateMiddleware: function (prop, value, template) {
                        if (prop === 'subtitle' || prop === 'title') {
                          if (value.indexOf("code")) {
                            return htmlDecode(value);
                          } else {
                            return value;
                          }
                        }
                      }
                    });
                    var $searchPage = $('.search-page');
                    var $searchOpen = $('.search-icon');
                    var $searchClose = $('.search-icon-close');
                    var $searchInput = $('#search-input');
                    var $body = $('body');

                    $searchOpen.on('click', function (e) {
                      e.preventDefault();
                      $searchPage.toggleClass('search-active');
                      var prevClasses = $body.attr('class') || '';
                      setTimeout(function () {
                        $body.addClass('no-scroll');
                      }, 400)

                      if ($searchPage.hasClass('search-active')) {
                        $searchClose.on('click', function (e) {
                          e.preventDefault();
                          $searchPage.removeClass('search-active');
                          $body.attr('class', prevClasses); // from closure 
                        });
                        $searchInput.focus();
                      }
                    });
                  });
                </script>

    <!-- Image to hack wechat -->
    <img src="/img/icon_wechat.png" width="0" height="0" />
    <!-- Migrate from head to bottom, no longer block render and still work -->
  </body>
</html>
